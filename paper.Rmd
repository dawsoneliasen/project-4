---
title: "MCMC Redistricting"
author: "Dawson Eliasen, Jonathan Olavarria, Henrique Rio"
date: "12/11/2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

# Motivation


## Introduction 

  Fair elections are a integral part of democracy for without it, the will of the people might not be respected and if that happens we no longer have a democracy. However, despite the huge importance of the elections in the US, there are still ways that a party can negatively impact the election by gaining an unfair advantage. One of the ways that this can happen, is gerrymandering where in order to gain a political advantage in a state by manipulating district boundaries. This issues has come before the supreme court, however it was ruled that it was up to the congress and the states to deal with it.
  
  Due to the scale of this issue, the paper by Fifield et al, proposes the use of a Markov Chain Monte Carlo method to automate the redistricting process, despite having a few Monte Carlo algorithms existing none of them have strong theoretical background. Fifield et al algorithm proposes to solve the automation redistricting by formulating it as a Graph Cut problem, where the MCMC samples the districts plans from arbitrary distributions over the set of n contiguous districts, they also implemented equal population constraint, which is a main requirement in the real-world problem.


## What is Redistricting?
 "In the United States is the process of drawing electoral district boundaries. A congressional act passed in 1967 requires that representatives be elected from single-member districts, except when a state has a single representative, in which case one state-wide at-large election be held." (Wikipedia). Redistricting also has to follow 6 different criteria, which are as follows.

Redistricting criteria:
    - compactness
    - contiguity
    - equal population
    - preservation of existing political communities
    - partisan fairness
    - racial fairness
  The compact criteria pertains to the size of each district where one district cannot be of a enormous size and another one be really small, they all have to be more or less similar in size. The contiguity constraint, stipulates that all that all of the district have to be continuous in area in the sense that one district cannot cut through the middle of the other one. The equal population constraint, e



## Gerrymandering
- What is Gerrymandering?
    - Is the act of actively redrawing district lines so that it tilts as many districts as possible in favor of a party, in order for a party to cement themselves in power.
    - e.g. A controversial redistricting that happened in Texas in 2003, where          republicans went from 15 seats in 2002 to 21 in 2004 (democrats got 11).
    - After this the case was brought to the supreme court, where it was ruled that the supreme court could not address gerrymandering, which leaves to congress and states to deal with it.


## Automated Redistricting
- Researchers have been trying to create a redistricting algorithm since the 1970s
- It began as a optimization problem, where the goal is trying to find the optimal redistricting plan.
- Due to the geographical dependence of redistricting in a state, it is essential to determine the distribution of redistricting plans under the redistricting criteria.
- Simulation Methods are more appropriate since it allows scholars to answer these questions,by  simulating different plans outcomes under different constraints.
- Yet only a few exist so far, using the same Monte Carlo simulation algorithm.
- We chose to reproduce a paper by Fifield from Harvard et. al., *Automated Redistricting Simulation Using Markov Chain Monte Carlo*


# Methodology


## Redistricting Problem Representation
Redistricting is represented as a “graph cut” problem, where a state is represented as a graph $G$, and each voting precinct $i$ is a node in the set of nodes $V$. There is an undirected edge $i \sim j$ connecting nodes $i, j$ if the precincts $i, j$ are contiguous (share a border). Then, we get voter districts by partitioning the set of nodes $V$. This leaves subgraphs that represent the congressional districts. Since districts are formed by “cutting” edges, we can think of redistricting as a “graph cut” problem. This is how the MCMC methods generate new samples of redistricting plans.


## Metropolis-Hastings
The Metropolis-Hastings algorithm is a Monte Carlo Markov Chain algorithm based on the simple accept-reject algorithm, used to simulate redistricting plans.

- Define a function $f(x)$, proportional to the pdf of the desired distribution
- Define a proposal distribution $g(x | y)$ that provides a new sample $x$ given the previous sample $y$
- Start with a valid sample, $x_0$
- At each iteration:
    - Generate a “candidate” sample $x^*$ from $g$ (perturb $x_i$)
    - Accept $x^*$ with probability equal to $\frac{f(x^*)}{f(x_i)}$


## Metropolis-Hastings Iteration Example
To simulate redistricting, “perturbation” looks like swapping precincts along existing district borders. \ref{fig:MCMC example} illustrates the perturbation process for an example sample in a Metropolis-Hastings chain. Perturbation works by identifying nodes that exist on congressional district borders and proposing swaps along the borders. This produces a perturbation of the previous sample which is accepted with acceptance ratio

$$
\alpha(\pi', \mathbf{CP} | \pi) = \min \Big(1,
    \Big(\frac{|B(\mathbf{CP}, \pi)|}{|B(\mathbf{CP}, \pi'|}\Big)^R 
    \frac{F(|B(\mathbf{CP}, \pi)|)(1- q)^{C(\pi', \mathbf{V_{CP}})}}{F(|B(\mathbf{CP}, \pi')|) (1- q)^{C(\pi, \mathbf{V_{CP}})}} \cdot
    \frac{g(\pi')}{g(\pi)} 
\Big)
$$

where $\pi$ is the current sample, $\pi'$ is the perturbed sample, $\mathbf{CP}$ is the set of connected components formed by $\pi$, and $C$ is a graph-cut function.


![MCMC example](figures/mcmc_example.png)


## `redist` Package
Fifield et. al. use a package called `redist` which implements this Metropolis-Hastings algorithm for simulating redistricting. `redist.mcmc` is a function for generating redistricting samples, and requires precinct adjacency matrix, population data, and assignments to a valid set of congressional districts as function inputs. The authors of the paper shared some code for reproduction, but the code was limited to generating figures and it was not generalizable to different data, so we re-implemented the simulation code to generate redistricting simulations for the state of Colorado.


## Data
Fifield et. al. use Pennsylvania shapefiles and election data from the Harvard Election Archive. However, the Harvard Election Archive Colorado dataset did not include congressional district assignments. Instead, we used a shapefile assembled by MGGG which was constructed from election data from Colorado Secretary of State’s Office, 2010 Census data from the U.S. Census Bureau Data API, and precinct borders from U.S. Census Bureau TIGER/Line shapefile repository.


## Simulation
Using the `sf` package, we read the Colorado shapefiles and calculated a precinct adjacency matrix with a package called `spdep`. Then, we used `redist.mcmc` to generate 3 MCMC chains of 10,000 samples each - this took a few hours. We initially tried 3 MCMC chains of 100,000 samples (this is what the authors of the paper do) - but this took to long and required more computing power than was available. We also tried applying a “compactness” constraint, but it requires providing a distance matrix of the nodes in the graph, which took too long to compute. Finally, we evaluate bias in the simulations using `redist.segcalc` and a modified version of the code shared by the authors of the paper.


# Results


## Starting Map (current districts)
```{r, include=FALSE}
library(tidyverse)
library(plyr)
library(sf)
library(RColorBrewer)
source('plotting_functions.R')
```




```{r, echo=FALSE, fig.cap="Current congressional districts in Colorado.\\label{fig:map}"}
co <- read_sf(dsn='co_precincts', layer='co_precincts')
co <- co %>% arrange(CD116FP)
from <- unique(co$CD116FP)
to <- seq_len(length(unique(co$CD116FP)))
co$CD116FP <- co$CD116FP %>% mapvalues(from, to)

ggplot(co, aes(fill=CD116FP)) +
    geom_sf(size=0) +
    scale_fill_brewer(palette='Set2')
```




In figure 1 above we see the current district map for the state of colorado. The districts are distinguished by the different colors and the legend on the right. The opaque white lines show the precinct lines (there are over 3000 precincts in the state of Colorado), as mentioned in the intorduction gerrymandering is the process of moving precincts from one district to another to sway political bias in certain districts or in an entire state. Each district shown above satisfies the equal population constraint stating that every district must have approximately the same population. At the moment politicians are doing this process by hand looking at each precinct's voting history and moving them around to benefit their political party. Redistricting happens once every 10 years after every census. The current district layout exhibits democratic bias which is as expected because democrats controlled the state legislature in 2010 which was the last census year.



## MCMC Summary



```{r, include=FALSE}
loadRData <- function(f) {
    load(f)
    get(ls()[ls() != 'f'])
}
```

```{r, include=FALSE}
co_sim1 <- loadRData('co_redist_mcmc1.RData')
co_sim2 <- loadRData('co_redist_mcmc2.RData')
co_sim3 <- loadRData('co_redist_mcmc3.RData')
co_sim1_seg <- redist.segcalc(co_sim1, co$USH18R, co$TOTPOP)
co_sim2_seg <- redist.segcalc(co_sim2, co$USH18R, co$TOTPOP)
co_sim3_seg <- redist.segcalc(co_sim3, co$USH18R, co$TOTPOP)
co_sim <- cbind(co_sim1$partitions[,!is.na(co_sim1_seg)],
                co_sim2$partitions[,!is.na(co_sim2_seg)], 
                co_sim3$partitions[,!is.na(co_sim3_seg)])
xax <- 1 - c(co_sim1$distance_original[!is.na(co_sim1_seg)],
             co_sim2$distance_original[!is.na(co_sim2_seg)],
             co_sim3$distance_original[!is.na(co_sim3_seg)])
co_sim_bias <- calc_sim_bias(co_sim, co$GOV18D, co$GOV18R)
```

```{r, echo=FALSE, fig.cap="Redistricting samples, percent of precincts changed vs. bias.\\label{fig:mcmc-summary}"}
plot_sim_bias(xax, co_sim_bias)
```


Now we can look at the bias asscoiated with our simulations. Our simulation consisted of 10,000 different and unique redistricting maps that the algorithm computed using our parameters and equal population constraint. Each point on the graph is a distinct Colorado district map. On the X-axis we have the percentage of precincts swapped for a particular simulation. On the Y-axis we have our calculated political bias. The red dotted line shows 0 bias, above that line is democratic bias and below that line is republican bias. The black line shows the current political bias which is slightly democratic.

There seems to be a connection between political bias and percentage of precincts swapped. When less than 10 percent of precincts are swapped the political bias changes very little and stays democratic but it can sway slightly closer to the ideal 0 bias line. However as more precincts get swapped we start to see a positive trend in the graph where partisan bias grows more and more in favor of democrats. According to our simulations in order to acheive 0 bias approximately 37 percent of precincts need to be swapped from their original district. The political bias can even become slightly republican with this proportion of precincts swapped. However, the over all trend is that the vast meajority of the simulations that were run return a district map of colorado that is even more democratically biased than it currently is. We believe this is due to the fact that Colorado has been trending away from being a swing state and becoming more of a solid "blue" shown by the outcomes of the presedential elections in the past 20 years.



## Minimum Bias Map
```{r, echo=FALSE, fig.cap="Redistricting sample with minimum bias.\\label{fig:min-bias-map}"}
plot_min_bias(co_sim, co_sim_bias, co, xax)
```


Here is the minimum bias map. This map shows the simulation with the political bias that is closest to 0. This map does satisfy all of the constraints put forth by the state of colorado for redistricting however it may be slightly unrealistic as far as a real world district map. The districts developed a "tree branch pattern" where they seem to branch out accross the entire state of colorado from the center outwards. This is because of a compactness constraint that we were not able to implement due to our limited computing power. The compactness constraint takes in a matrix of pair wise distances between precincts and makes sure that all precincts in a district are not "too" far away from eachother. We tried running our simulations using this constraint but it crashed our computers so we decided to run or simulations without compactness. However we think there is something to be learned from this minimum bias map, it shows just how different districts need to look in Colorado to obtain a 0 bias state.

## Moving Forward

Moving forward we would like to exlpore the compactness constraint to attempt to get a more realistic redistricted map of Colorado. Also bumping up the number of simulations could prove to be useful, our limit with the computers that we have is 10,000 runs getting that number up to 100,000 would be ideal. However being able to do those two things woiuld require access to more powerful computers. Also running this analysis on another state could be very interesting, Texas for example, a historically republican state, has shown a trend of democratic voting increase. It would be very interesting to look into how gerrymandering has been affecting Texas politics. 








